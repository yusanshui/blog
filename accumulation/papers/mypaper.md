### abstract
云原生的兴起，使容器和容器编排技术变得越来越有意义。越来越多的企业愿意使用自动化的方式来在云上部署自己的应用。云原生时代的到来，对存储系统提出了更高的要求。本地存储和集中式存储很难满足云原生架构的要求，分布式存储是在性能、可靠性、和灵活性上都非常适应云原生系统。但分布式存储系统对团队运维技术提出了很高的要求，我们要在目前只有大公司大团队才能维护分布式存储系统。对于小公司来说，如果不是性能要求太高，需要定制化的存储方案，采用商务云存储系统性价比不高。另一种方式是搭建自建存储服务，但自建存储方案需要专业的运维团队支持，对于一般的公司来说运维成本太高。因此，我们设计和实现了一种分布式存储系统，极大地简化了用户对底层容器化部署的复杂工作，同时提供动态增加和减少存储容量，用户可以通过调整集群节点数量或者更换存储设备的方式调整存储容量而不丢失数据，降低企业了运维压力。目前我们已经在实际生产环境中使用了我们设计的存储系统，能很好的满足我们的需求。

### introduction
近来，云原生架构开始兴起，云原生是指应用程序原本就是为了部署在云上而设计的，云原生的优势是可以让应用弹性部署，即面对负载过重的服务，可以配合负载均衡机制实现应用实例的弹性扩展。云原生时代的到来，也对存储系统提出了更高的要求。目前可以应用于云的存储方案有本地存储、集中式存储和分布式存储。其中本地存储由于可靠性差、可扩展性不高，底层无法实现多副本，不是云原生的架构的合适存储方案。集中式存储是将所有业务的存储放在一台高性能机器上，使存储与业务单元分离开，从而实现高可用，但面对高并发场景，存储访问请求很快就会达到单机存储控制器处理的瓶颈。同时集中式存储无法满足应用实例的动态扩展，即当应用实例增加时，需要手动的增加对于的存储卷来存储对应的应用数据。分布式存储可以解决并发访问的问题，提高可靠性和稳定性，但在分布式环境下，最重要的是要考虑节点的损坏，提供数据冗余机制，防止数据丢失，并且提供动态的调整存储容量的方式。对于一般公司来说，可以选择市场上的已有的云存储服务，这种云存储服务可以省去用户对于底层存储的部署的复杂工作，为用户提供了访问存储的接口，使用户可以访问各种高性能的存储类型，降低了运维成本，但缺点是费用太高，而且不同的云存储提供商提供不同的接口，很难实现存储的统一接入。但一般公司团队一般都缺少强大的运维能力，很难搭建自己的分布式存储系统。所以目前一个合理分布式存储系统需要满足：
* 高可靠性
* 高性能
* 低运维成本
* 动态扩展性
kubernetes是谷歌公司推出的容器编排技术，它可以在集群中调度和部署多个应用实例，分布式存储系统也是有集群组成，因此我们可以将分布式系统容器化，采用现有的kubernetes来部署和管理，这样做可以充分利用kubernetes的优势，减少手动调度。


kubernetes通过在容器的基础上包装一层pod，从而实现对容器的组织和调度。kubernetes 同时提供为容器提供底层存储的接口，这为用户如何选择底层的存储提供了很大的自由度。
kubernetes可以编排docker实现应用的动态创建和调度。所以我们在kubernetes开发了一套自动化分布式存储系统，简化了用户部署kubernetes时搭建底层存储系统的复杂工作，并且降低了用户的运维成本，用户可以动态的增加底层存储的容量，同时提供高可靠性，由于kubernetes本身就支持应用的调度，因此我们的系统也支持实例的动态扩展，从而实现负载均衡。


### 相关工作
* 找一下有关存储的工作

### 探索过程中的经验
* 使用nfs作为存储 缺点 底层不能动态扩展

采用local卷作为k8s环境底层的好处：
1. 我们提供以不同的底层存储上一键搭建ceph的方式
2. 相比于hostPath卷，local卷可以可以根据节点的容忍度调度Pod,保证Pod崩溃后重启，绑定相同的pv，保证数据不丢失
采用local卷local provision 方式，可以通过指定StorageClass与符合条件的local卷绑定，即将每台机器视为一个local卷，即一个PV，用户只需要在PVC里指定StorageClass，StorageClass选择一个合适的PV与POD进行绑定
3.但目前local不支持动态创建PV，导致如果使用local卷，就需要手动创建多个PV，目前支持动态卷制备的基本是分布式存储系统。
4. 相比于其他分布式存储，采用local卷减少网络IO
搭建ceph
1. ceph是分布式存储系统，如果底层存储是ceph的话，就可以支持动态创建PV
2. 由于ceph是分布式的，由多台机器组成的 我们就可以使用k8s的多个pod来模拟ceph存储
3. 我们在local基础上，搭建ceph分布式存储系统
4. 在ceph的基础上可以搭建不文件系统或者block存储块
5. ceph可以利用文件系统或者block块动态提供pv


### 描述我们的系统架构
我们系统架构为
k8s环境、底层云分布式存储、存储服务、前端部署页面、监控系统、（日志系统）

集群环境：云分布式存储系统是有多个节点构成的，我们需要在多个节点上搭建我们的存储系统，因此我们可以充分利用已有的集群部署工具来管理我们的集群，如kubernetes。

k8s环境：目前，在云原生中，应用的弹性扩展离不开容器化技术，目前最流行的容器化的是docker，docker是利用linux kernel和 linux kernel 功能，将各种应用或者进程进行资源隔离，利用应用镜像实现"run any where"的理念。随着容器化的流行，容器化编排技术也随之而出，容器化编排技术就是实现对容器的自动化组织、调度与部署。目前市场最热门的容器化编排技术是谷歌公司推出的kubernetes，将多台机器组装成集群，kubernetes可以将多个应用在集群上进行调度和部署，减少了手动部署的繁琐工作。由于kubernetes本身可以看做是集群管理工具，分布式存储系统部署在集群中，我们可以利用kubernetes部署和管理我们的分布式存储系统。
（介绍k8s?)

云分布式存储：针对磁盘、lvm等传统存储或者kubernetes的storageclass，搭建云分布式存储系统。由于分布式系统考虑了节点的损坏，提供了副本机制，所以数据不会因某一节点或k8s pv的删除而丢失，同时也可以随时调整底层存储容量的大小，来实现云分布式存储系统的可扩展性。
（介绍ceph？）

存储服务：针对不同用户的需求，可以在云分布存储系统上搭建不同的存储服务如文件系统、块存储、对象存储。

监控系统：监控各个系统的使用存储的情况和健康状态，方便用户及时调整存储设备。


需要满足的用户需求：
支持用户快速搭建想要的存储系统如filesystem or block，提供存储服务
提供k8s storageclass，支持动态制备
更换或调整节点
支持不同类型的底层存储，如磁盘、lvm、文件系统
集群的调整如集群节点的添加或删除

### 介绍我们的实现 implemention
针对磁盘、lvm映射成同一层设备
使用local卷实现
使用ceph实现
用户使用增删节点
模拟底层存储损坏，数据是否会丢失

### 描述我们的性能对比
文件写入、独处

### real application
平台应用、效果

### 结论


### featurework
数据跟踪？类似facebook messages


















* 介绍我们的系统都包含了什么 包括其他工作有的东西 我们也可以做
* 介绍我们的focus是什么 解决了什么样的用户需求
* 介绍我们的系统依赖于什么，该依赖用了什么算法

* 发现动态化存储的重要性
* k8s动态存储分配
* 利用ceph存储 ceph可扩展的好处
* 使用本地存储的缺点
* 数据库的修改
* 介绍operator
* 介绍 ceph
* 介绍k8s的好处
* 介绍容器的好处
* 介绍动态存储的好处

为了便于用户调整存储，我们增加了一些接口，可以快速查看我们的存储系统中已有的节点和设备，将节点或者设备加入或者删除
osd 不依赖于位置信息 了解一下rookceph 的故障机制 每步操作的输入输出进行描述 执行性能的优化 可以通过优化ceph之类的东西 日志恢复
避免网络问题，保证实验的准确性



### functional module design
描述各种场景 参考On distributed storage 

### 介绍我们系统的多个层次的作用
描述API，有哪些操作不支持

分布式存储系统运维成本非常高在云生产环境中，节点损坏是非常常见的
云原生的起源，k8s的诞生起源
随着k8s的兴起，容器化部署显得越来越重要
存储的重要性
可扩展的重要性
为什么要做这个系统，这种系统目前存在一些什么瓶颈我们克服了
节点失效是常有的事
Boxwood